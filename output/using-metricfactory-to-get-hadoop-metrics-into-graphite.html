<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Using MetricFactory to get Hadoop metrics into Graphite.</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Using MetricFactory to get Hadoop metrics into Graphite."/>
            <meta property="og:url" content="http://smetj.net/using-metricfactory-to-get-hadoop-metrics-into-graphite.html"/>
            <meta property="og:description" content="Without metrics we're flying blind and that's very much the case with  Hadoop.  Hadoop is a well known framework to build reliable, scalable and distributed computing clusters.  The Hadoop framework  is a complex environment which "out of the box" hardly offers any metrics oversight on how the different ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://smetj.net/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://smetj.net/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://smetj.net/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://smetj.net/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>


    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40703057-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://smetj.net" class="navbar-brand">Project site of Jelle Smet</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://smetj.net/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/engineering.html">Engineering</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/misc.html">Misc</a>
                        </li>
                        <li class="active">
                            <a href="http://smetj.net/category/monitoringlove.html">#monitoringlove</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://smetj.net/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://smetj.net/using-metricfactory-to-get-hadoop-metrics-into-graphite.html"
                       rel="bookmark"
                       title="Permalink to Using MetricFactory to get Hadoop metrics into Graphite.">
                        Using MetricFactory to get Hadoop metrics into Graphite.
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>do 10 januari 2013
    </span>



</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Without metrics we're flying blind and that's very much the case with
&nbsp;<a class="reference external" href="http://hadoop.apache.org/">Hadoop</a>. &nbsp;Hadoop is a well known framework to build reliable,
scalable&nbsp;and distributed computing clusters. &nbsp;The Hadoop framework &nbsp;is a
complex environment which &quot;out of the box&quot; hardly offers any metrics
oversight on how the different components are performing.</p>
<p><a class="reference external" href="http://graphite.wikidot.com/">Graphite</a>&nbsp;is king of the hill when it comes to graphing metrics with
open source. &nbsp;Hadoop doesn't support Graphite's data format and way to
submit metrics, however it does natively support
the&nbsp;<a class="reference external" href="http://ganglia.sourceforge.net/">Ganglia</a>&nbsp;graphing framework. &nbsp;That is something we are going to
use to our advantage.</p>
<p><a class="reference external" href="https://github.com/smetj/metricfactory">MetricFactory</a>&nbsp;is a modular tool which allows you to build servers
which can do &quot;stuff&quot; with metrics. &nbsp;In this case &quot;stuff&quot; means accepting
Ganglia metrics, convert and submit them to the Graphite framework.</p>
<p>The information this blog post is just another way of doing things which
might suit your needs better than any other available options.</p>
<div class="section" id="hadoop-metrics">
<h2>Hadoop metrics</h2>
<p>As we already mentioned Hadoop can generate Ganglia formatted metrics.
&nbsp;Hadoop metrics are controlled by
/etc/hadoop/conf/hadoop-metrics.properties</p>
<p>You should have at least following entries:</p>
<pre class="literal-block">
dfs.class=org.apache.hadoop.metrics.ganglia.GangliaContext31
dfs.period=10
dfs.servers=metricfactory-001
</pre>
<pre class="literal-block">
mapred.class=org.apache.hadoop.metrics.ganglia.GangliaContext31
mapred.period=10
mapred.servers=metricfactory-001
</pre>
<pre class="literal-block">
jvm.class=org.apache.hadoop.metrics.ganglia.GangliaContext31
jvm.period=10
jvm.servers=metricfactory-001
</pre>
<pre class="literal-block">
rpc.class=org.apache.hadoop.metrics.ganglia.GangliaContext31
rpc.period=10
rpc.servers=metricfactory-001
</pre>
<p>The rpc.period defines the interval to submit metrics. &nbsp;In this case 10
seconds.</p>
</div>
<div class="section" id="graphite">
<h2>Graphite</h2>
<p>The Graphite instance does nothing particular. &nbsp;You can consult the
graphs by visiting following URL:
<a class="reference external" href="http://">http://</a><a class="reference external" href="http://graphite-001/dashboard/">http://graphite-001/dashboard/</a></p>
<p><a class="reference external" href="pics/Screenshot-from-2013-01-07-223750.png"><img alt="Screenshot from 2013-01-07 22:37:50" src="pics/Screenshot-from-2013-01-07-223750-300x150.png" /></a></p>
</div>
<div class="section" id="metricfactory">
<h2>MetricFactory</h2>
<p>MetricFactory's setup is controlled through so called <a class="reference external" href="https://github.com/smetj/experiments/tree/master/metricfactory">bootstrap
files</a>. &nbsp;These files contain&nbsp;the information on which modules need to
be loaded, how they are initiated and how &nbsp;they are connected to each
other.</p>
<p>For this scenario we need to have at least:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/smetj/wishboneModules">UDP input</a> (The Ganglia metrics come in over UDP).</li>
<li><a class="reference external" href="https://github.com/smetj/metricfactory/blob/master/metricfactory/decoder/ganglia.py">Ganglia decoder</a>&nbsp;(Deserialize the XDR format into a generic
format.)</li>
<li><a class="reference external" href="http://wishbone.readthedocs.org/en/latest/modules.html?highlight=graphite#wishbone.module.Graphite">Graphite encoder</a> (Convert the generic format into a Graphite
format.)</li>
<li><a class="reference external" href="https://github.com/smetj/wishboneModules">A TCP client</a> (Write the metrics into Graphite)</li>
</ul>
<div class="section" id="a-small-test">
<h3>A small test</h3>
<p>First let's make a small test using <a class="reference external" href="https://github.com/smetj/experiments/blob/master/metricfactory/hadoop2graphite/hadoop2graphite.yaml">this</a> bootstrapfile. &nbsp;Instead of
writing the converted data to Graphite, we're going to print it to
STDOUT. &nbsp;Not very useful, although this way we can verify clearly
whether we have data coming in and whether the output format is as we
expect.</p>
<p>We can start &nbsp;MetricFactory with the debug option so it does not detach
into the background. &nbsp;CTRL-C stops the process again:</p>
<pre class="literal-block">
[vagrant&#64;metricfactory-001 ~]$ metricfactory debug --config /home/vagrant/experiments/metricfactory/ganglia2graphite/ganglia2graphite2stdout.json
2013-01-07 22:38:06,150 INFO root: Starting MetricFactory in foreground.
2013-01-07 22:38:06,156 INFO root: Instance #0 started.
2013-01-07 22:38:06,158 INFO root: Started with pids: 3702, 3703
2013-01-07 22:38:06,165 INFO Intance #0:buffer: Initiated.
2013-01-07 22:38:06,168 INFO Intance #0:udpserver: started and listening on port 8649
2013-01-07 22:38:06,170 INFO Intance #0:ganglia: Initiated.
2013-01-07 22:38:06,171 INFO Intance #0:graphite: Initiated.
2013-01-07 22:38:06,172 INFO Intance #0:stdout: Initiated.
2013-01-07 22:38:06,174 INFO Intance #0:buffer: Started.
2013-01-07 22:38:06,174 INFO Intance #0:stdout: Started.
2013-01-07 22:38:06,175 INFO Intance #0:ganglia: Started.
2013-01-07 22:38:06,175 INFO Intance #0:graphite: Started.
0 - systems.hadoop-001.jvm.JobTracker.metrics.gcCount 159 1357598286.52
1 - systems.hadoop-001.jvm.JobTracker.metrics.gcTimeMillis 481 1357598286.52
2 - systems.hadoop-001.jvm.JobTracker.metrics.logError 0 1357598286.52
3 - systems.hadoop-001.jvm.JobTracker.metrics.logFatal 0 1357598286.52
4 - systems.hadoop-001.jvm.JobTracker.metrics.logInfo 57 1357598286.52
5 - systems.hadoop-001.jvm.JobTracker.metrics.logWarn 1 1357598286.52
6 - systems.hadoop-001.jvm.JobTracker.metrics.maxMemoryM 3866.6875 1357598286.52
7 - systems.hadoop-001.jvm.JobTracker.metrics.memHeapCommittedM 15.125 1357598286.52
8 - systems.hadoop-001.jvm.JobTracker.metrics.memHeapUsedM 7.0045853 1357598286.52
9 - systems.hadoop-001.jvm.JobTracker.metrics.memNonHeapCommittedM 23.1875 1357598286.52
10 - systems.hadoop-001.jvm.JobTracker.metrics.memNonHeapUsedM 19.089851 1357598286.52
11 - systems.hadoop-001.jvm.JobTracker.metrics.threadsBlocked 0 1357598286.52
12 - systems.hadoop-001.jvm.JobTracker.metrics.threadsNew 0 1357598286.52
... snip ...
</pre>
</div>
<div class="section" id="a-standalone-instance">
<h3>A standalone instance</h3>
<p>We can now start to write the metrics into Graphite. &nbsp;For this we
require&nbsp;<a class="reference external" href="https://github.com/smetj/experiments/blob/master/metricfactory/hadoop2graphite/hadoop2graphite.yaml">a bootstrap file</a> which &nbsp;actually writes the data into
Graphite:</p>
<pre class="literal-block">
[vagrant&#64;metricfactory-001 ~]$ metricfactory debug --config /home/vagrant/experiments/metricfactory/ganglia2graphite/ganglia2graphite.json
</pre>
</div>
<div class="section" id="multiple-instances">
<h3>Multiple instances</h3>
<p>MetricFactory is build using the Wishbone library, which on its turn
uses Gevent with green threads on top of a libevent loop. &nbsp;Something to
keep in mind when working with greenthreads on a libevent loop is that
they are great to deal with IO bound processing but not with CPU bound
processing. &nbsp;Because of that (cutting corners here) our whole setup runs
inside 1 process which doesn't take advantage of a multiple CPU
architecture. &nbsp;This can become problematic because every time we're
doing a CPU intensive task, the libevent loop stops, something we want
to avoid as much as possible.</p>
<p>A WishBone based setup can be started with the --instances parameter,
which basically starts a number of identical processes thus taking
advantage of a multiple CPU architecture. In our case however we can not
take advantage of this since we require an UDP listener in our setup
hence we can't have multiple instances bind to that port at the same
time. &nbsp;So let's get creative and&nbsp;split the setup into 2 parts:</p>
<div class="section" id="a-decoder-with-multiple-instances">
<h4>A decoder with multiple instances</h4>
<p>This setup creates 5 parallel instances. &nbsp;Each instance accepts input
from its own Unix domain socket.</p>
<pre class="literal-block">
[vagrant&#64;metricfactory-001 ~]$&nbsp;metricfactory debug --config /home/vagrant/experiments/metricfactory/ganglia2graphite/uds-ganglia-graphite.json --instances 5 --pid /tmp/uds-ganglia-graphite.pid
</pre>
</div>
<div class="section" id="a-receiver">
<h4>A receiver</h4>
<p>Accepts all the data on UDP and distributes that evenly over multiple
decoders each listening on a domain socket.</p>
<pre class="literal-block">
[vagrant&#64;metricfactory-001 ~]$ metricfactory debug --config /home/vagrant/experiments/metricfactory/ganglia2graphite/loadbalance-ganglia.json --pid /tmp/loadbalance-ganglia.pid
</pre>
<p><em>`The UDSclient module`_ can be initiated with &quot;pool&quot; set to &quot;True&quot;.When
enabled the defined path will be considered a directory containing one
or more Unix domain sockets. The client &quot;round robins&quot; over all domain
sockets found in that directory. Worth to mention is the buffer module,
which buffers the Graphite data and when full submits the batch.</em></p>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using this setup we can accept Ganglia metrics over UDP from Hadoop,
convert using multiple parallel processes the metrics to Graphite format
in and submit the converted metrics in batches to Graphite. &nbsp;I'm
planning to add more functionality to MetricFactory. &nbsp;Currently it can
tackle mod_gearman and Ganglia data. &nbsp;Using the examples in this
article you should be able to setup your own MetricFactory based setups
relatively easy. &nbsp;If you require support you can submit a message to the
<a class="reference external" href="https://groups.google.com/forum/?fromgroups#!forum/metricfactory">MetricFactory mailing list</a>.</p>
</div>

            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'smetj'; // required: replace example with your forum shortname
            var disqus_identifier = 'using-metricfactory-to-get-hadoop-metrics-into-graphite';
            var disqus_url = 'http://smetj.net/using-metricfactory-to-get-hadoop-metrics-into-graphite.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/smetj"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/smetj"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



                <li class="list-group-item"><a href="http://smetj.net/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/metricfactory.html">
                                metricfactory
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/monitoringlove.html">
                                monitoringlove
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/moncli.html">
                                moncli
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/graphite.html">
                                graphite
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/rabbitmq.html">
                                rabbitmq
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/metrics.html">
                                metrics
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/wishbone.html">
                                wishbone
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://smetj.net/tag/monitoring.html">
                                monitoring
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/tools.html">
                                tools
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/company.html">
                                company
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/events.html">
                                events
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/amqp.html">
                                amqp
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/krolyk.html">
                                krolyk
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mqtt.html">
                                mqtt
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/gevent.html">
                                gevent
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/messaging.html">
                                messaging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/molog.html">
                                molog
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/nagios.html">
                                nagios
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/elasticsearch.html">
                                elasticsearch
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/pypy.html">
                                pypy
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mod_gearman.html">
                                mod_gearman
                            </a>
                        </li>
        </ul>
    </section>


    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://smetj.net/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'smetj',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://smetj.net/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2013 Jelle Smet &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://smetj.net/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://smetj.net/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'smetj'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>