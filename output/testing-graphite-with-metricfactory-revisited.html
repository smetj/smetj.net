<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Testing Graphite with MetricFactory revisited</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Testing Graphite with MetricFactory revisited"/>
            <meta property="og:url" content="http://smetj.net/testing-graphite-with-metricfactory-revisited.html"/>
            <meta property="og:description" content="In this post we revisit a previously posted article on how we can test and stress test a Graphite setup. This is basically a rewrite of that article since the Wishbone and MetricFactory software have meanwhile changed enough to dedicate a new article to it. Our end-goal still stands. We ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://smetj.net/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://smetj.net/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://smetj.net/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://smetj.net/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>


    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40703057-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://smetj.net" class="navbar-brand">Project site of Jelle Smet</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://smetj.net/category/development.html">Development</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/engineering.html">Engineering</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/misc.html">Misc</a>
                        </li>
                        <li class="active">
                            <a href="http://smetj.net/category/monitoringlove.html">#monitoringlove</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://smetj.net/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://smetj.net/testing-graphite-with-metricfactory-revisited.html"
                       rel="bookmark"
                       title="Permalink to Testing Graphite with MetricFactory revisited">
                        Testing Graphite with MetricFactory revisited
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>zo 20 oktober 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="http://smetj.net/tag/monitoringlove.html">monitoringlove</a>
        /
	<a href="http://smetj.net/tag/graphite.html">graphite</a>
        /
	<a href="http://smetj.net/tag/metricfactory.html">metricfactory</a>
        /
	<a href="http://smetj.net/tag/python.html">python</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In this post we revisit a previously posted article on how we can test and
stress test a Graphite setup. This is basically a rewrite of that article
since the Wishbone and MetricFactory software have meanwhile changed
enough to dedicate a new article to it.</p>
<p>Our end-goal still stands.  We want to test and understand the behavior of a
Graphite setup by writing metrics into it using different scenarios.</p>
<div class="section" id="installation">
<h2>Installation</h2>
<p>Installing metricfactory is a matter of checking out the project from
Git and running the installer. &nbsp;All dependencies should be downloaded
automatically.</p>
<pre class="literal-block">
$ git clone https://github.com/smetj/metricfactory
$ cd metricfactory
$ sudo python setup.py install
</pre>
<p>An additional <a class="reference external" href="https://github.com/smetj/wishboneModules">Wishbone module</a>:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/smetj/wishboneModules/tree/master/wb_output_tcp">https://github.com/smetj/wishboneModules/tree/master/wb_output_tcp</a></li>
</ul>
<pre class="literal-block">
$ git clone https://github.com/smetj/wishboneModules
$ cd wishboneModules/wb_output_tcp/
$ sudo python setup.py install
</pre>
<p>One or more of following packages might be required to successfully
finish the install:</p>
<blockquote>
gcc, gcc-c++, make, python-devel, Cython</blockquote>
<p>Once installed you can execute following command:</p>
<pre class="literal-block">
$ metricfactory list
$ metricfactory list --group metricfactory.encoder
$ metricfactory list --group metricfactory.decoder
$ metricfactory list --group metricfactory.test
</pre>
<p>That should return a list of all available modules. &nbsp;You should see at
least tcp, hammer and graphite.</p>
</div>
<div class="section" id="bootstrap">
<h2>Bootstrap</h2>
<p>Starting Metricfactory requires a bootstrap file. &nbsp;A bootstrap file is a YAML
formatted file containing the configuration of which modules to initiate and
which path events will follow through these module instances.</p>
<p>All bootstrap files used throughout this article can be found <a class="reference external" href="https://github.com/smetj/experiments/blob/master/metricfactory/hammerGraphite">here</a>.</p>
</div>
<div class="section" id="scenario-1-submit-fixed-number-of-metrics-to-graphite">
<h2>Scenario 1: Submit fixed number of metrics to graphite.</h2>
<p>Let's say we have a Graphite setup of 1 carbon-relay instance which forwards
metrics to 1 or more carbon instances. &nbsp;We want to see how Graphite behaves
under a predictable load.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre>---
modules:

    hammer:
        module: metricfactory.test.hammer
        arguments:
            batch: 1
            batch_size: 100
            set_size: 100
            value: 1000

    encodegraphite:
        module: wishbone.builtin.metrics.graphite

    tcp:
        module: wishbone.output.tcp
        arguments:
            host: graphite-001
            port: 2013

routingtable:

    - hammer.outbox             -&gt; encodegraphite.inbox
    - encodegraphite.outbox     -&gt; tcp.inbox
...
</pre></div>
</td></tr></table><p>The hammer module (line 4) is the module which generates metrics in a generic
format. The module is initialized to produce 1 batch (line 7) of metrics
consisting out of 100 unique sets (line 8) each containing 100 metrics
(line9). This means 10000 unique metrics are generated. Batch (line 7)
determines how many times we want to regenerate this collection of metrics.  A
value of 0 would mean indefinitely.  The sleep parameter (not used, default 1)
determines the time in seconds between each batch. The value parameter (line
10) determines the maximum value the random generated metric value can be.</p>
<p>The routing table (line 21) tells us events are traveling through the modules
in following order:</p>
<blockquote>
hammer -&gt; encodegraphite -&gt; tcp</blockquote>
<p>The tcp module (line 15) submits the metrics over TCP to the destination
defined with the host (line 18) and port (line 19)</p>
<p>Start the server in the foreground using following command:</p>
<pre class="literal-block">
$ metricfactory debug --config hammer_scenario_1.yaml
</pre>
<p>You can stop by pressing ctrl+c.</p>
<p><a class="reference external" href="pics/testing-graphite-with-metricfactory-revisited-001.png"><img alt="graphite1" src="pics/testing-graphite-with-metricfactory-revisited-001.png" /></a></p>
<p>When reviewing the metricsReceived values of both the carbon.relay as
carbon.cache we see we have received the expected amount of metrics.</p>
<p>Keep in mind since each generated metric is unique, <strong>10000 wsp files</strong> are
created. It's likely that after running this test,  you will only find a
subset of the generated data stored in Graphite.  This is because Graphite
does rate limiting and is not creating all wsp files in order not to hammer
the disks.  You might want to tweak Graphite to meet your expectations and
rerun the above setup to test your setup.</p>
</div>
<div class="section" id="scenario-2-submit-a-fixed-number-of-metrics-to-2-carbon-relays">
<h2>Scenario 2: Submit a fixed number of metrics to 2 carbon-relays</h2>
<p>Let's say we have a setup with 2 carbon relays with multiple carbon-caches
behind that.  In this case you might want to verify whether you can really
afford to loose a relay node.  We can use the same approach as we did in
scenario 1 and produce and submit a known number of metrics.</p>
<p>The below bootstrap file is setup in such a way that produced metrics are
spread over 2 tcp destinations.  You might want to execute a couple of runs
while killing parts of your Graphite setup to verify it behaves as expected
and whether there is no metric loss.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre>---
modules:

    hammer:
        module: metricfactory.test.hammer
        arguments:
            batch: 10
            batch_size: 100
            set_size: 100
            value: 1000
            sleep: 1

    encodegraphite:
        module: wishbone.builtin.metrics.graphite

    funnel:
        module: wishbone.builtin.flow.funnel

    balance:
        module: wishbone.builtin.flow.roundrobin

    tcp1:
        module: wishbone.output.tcp
        arguments:
            host: graphite-001
            port: 2013

    tcp2:
        module: wishbone.output.tcp
        arguments:
            host: graphite-002
            port: 2013

routingtable:

    - hammer.outbox             -&gt; encodegraphite.inbox
    - encodegraphite.outbox     -&gt; funnel.two

    - funnel.outbox             -&gt; balance.inbox
    - balance.one               -&gt; tcp1.inbox
    - balance.two               -&gt; tcp2.inbox

    - tcp1.failed               -&gt; funnel.one
    - tcp2.failed               -&gt; funnel.three
...
</pre></div>
</td></tr></table><p>Start the server in the foreground using following command:</p>
<pre class="literal-block">
$ metricfactory debug --config hammer_scenario_2.yaml
</pre>
<p>You can stop by pressing ctrl+c.</p>
<p>The above example will send 10 batches (line 7) of 100 sets (line 8) of 100
metrics (line 9) resulting into 100000 unique metrics.  Between each batch
10000 metrics we wait 1 second (line 11).</p>
</div>
<div class="section" id="scenario-3-determine-the-maximum-throughput-of-metrics">
<h2>Scenario 3: Determine the maximum throughput of metrics</h2>
<p>Let's say we want to have a ballpark number of how many metrics per second our
Graphite instance is able to receive.</p>
<p>For this we use the below bootstrap file:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre>---
modules:

    hammer:
        module: metricfactory.test.hammer
        arguments:
            batch: 0
            batch_size: 100
            set_size: 100
            value: 1000

    encodegraphite:
        module: wishbone.builtin.metrics.graphite

    tcp:
        module: wishbone.output.tcp
        arguments:
            host: graphite-001
            port: 2013

routingtable:

    - hammer.outbox             -&gt; encodegraphite.inbox
    - encodegraphite.outbox     -&gt; tcp.inbox
...
</pre></div>
</td></tr></table><p>By setting the batch argument (line 10) to 0, we indefinitely send the defined
batch.  If we overflow Metricfactory because we can't write metrics out fast
enough , throttling will be enabled automatically.</p>
<p>You could even start X amount of similar parallel processes by using the
--instances parameter when bootstrapping:</p>
<pre class="literal-block">
$ metricfactory debug --config hammer_scenario_3.yaml --instances 4
</pre>
<p><img alt="graphite3" src="pics/scenario_3.png" /></p>
<p>As you can see we're maxing out the cpu usage of the relay server while
processing on average 1117000 metrics/s.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Generating a predictable number of metrics can be practical to verify whether
Graphite behaves as expected in different scenarios.  It becomes even more
meaningful when you have a more complex environment with a number of relays
with sharding and duplication policies. &nbsp;By generating batches of continuous
mertics it's possible to get an idea about the throughput of your Graphite
setup.</p>
</div>

            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'smetj'; // required: replace example with your forum shortname
            var disqus_identifier = 'testing-graphite-with-metricfactory-revisited';
            var disqus_url = 'http://smetj.net/testing-graphite-with-metricfactory-revisited.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/smetj"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/smetj"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



                <li class="list-group-item"><a href="http://smetj.net/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/moncli.html">
                                moncli
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/graphite.html">
                                graphite
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/monitoringlove.html">
                                monitoringlove
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/metricfactory.html">
                                metricfactory
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/rabbitmq.html">
                                rabbitmq
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/wishbone.html">
                                wishbone
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/metrics.html">
                                metrics
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://smetj.net/tag/monitoring.html">
                                monitoring
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/events.html">
                                events
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mod_gearman.html">
                                mod_gearman
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mqtt.html">
                                mqtt
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/company.html">
                                company
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/gevent.html">
                                gevent
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/krolyk.html">
                                krolyk
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/nagios.html">
                                nagios
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/amqp.html">
                                amqp
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/tools.html">
                                tools
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/molog.html">
                                molog
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/pypy.html">
                                pypy
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/messaging.html">
                                messaging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/elasticsearch.html">
                                elasticsearch
                            </a>
                        </li>
        </ul>
    </section>


    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://smetj.net/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'smetj',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://smetj.net/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2013 Jelle Smet &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://smetj.net/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://smetj.net/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'smetj'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>