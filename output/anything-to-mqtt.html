<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Anything to MQTT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Jelle Smet">

    <!-- Le styles -->
    <link rel="stylesheet" href="http://smetj.net/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="http://smetj.net/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="http://smetj.net/theme/css/font-awesome.css" rel="stylesheet">

    <link href="http://smetj.net/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://smetj.net/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://smetj.net/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://smetj.net/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://smetj.net/theme/images/apple-touch-icon-114x114.png">

    <link href="http://smetj.net/" type="application/atom+xml" rel="alternate" title="Project site of Jelle Smet ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://smetj.net/index.html">Project site of Jelle Smet </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="http://smetj.net/category/development.html">
						<i class="icon-folder-open icon-large"></i>development
					</a>
                  </li>
                  <li class="active">
                    <a href="http://smetj.net/category/engineering.html">
						<i class="icon-folder-open icon-large"></i>engineering
					</a>
                  </li>
                  <li >
                    <a href="http://smetj.net/category/misc.html">
						<i class="icon-folder-open icon-large"></i>misc
					</a>
                  </li>
                  <li >
                    <a href="http://smetj.net/category/monitoringlove.html">
						<i class="icon-folder-open icon-large"></i>#monitoringlove
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="http://smetj.net/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="http://smetj.net/" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="http://twitter.com/smetj"><i class="icon-twitter-sign icon-large"></i>twitter</a></li>
    <li><a href="http://github.com/smetj"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="http://smetj.net/category/development.html">
    <i class="icon-folder-open icon-large"></i>development
</a>
</li>
<li>
<a href="http://smetj.net/category/engineering.html">
    <i class="icon-folder-open icon-large"></i>engineering
</a>
</li>
<li>
<a href="http://smetj.net/category/misc.html">
    <i class="icon-folder-open icon-large"></i>misc
</a>
</li>
<li>
<a href="http://smetj.net/category/monitoringlove.html">
    <i class="icon-folder-open icon-large"></i>#monitoringlove
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-2">
    <a href="http://smetj.net/tag/rabbitmq.html">
        <i class="icon-tag icon-large"></i>rabbitmq
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/elasticsearch.html">
        <i class="icon-tag icon-large"></i>elasticsearch
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/amqp.html">
        <i class="icon-tag icon-large"></i>amqp
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/krolyk.html">
        <i class="icon-tag icon-large"></i>krolyk
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/messaging.html">
        <i class="icon-tag icon-large"></i>messaging
    </a>
</li>
<li class="tag-1">
    <a href="http://smetj.net/tag/moncli.html">
        <i class="icon-tag icon-large"></i>moncli
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/nagios.html">
        <i class="icon-tag icon-large"></i>nagios
    </a>
</li>
<li class="tag-1">
    <a href="http://smetj.net/tag/monitoringlove.html">
        <i class="icon-tag icon-large"></i>monitoringlove
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/company.html">
        <i class="icon-tag icon-large"></i>company
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/molog.html">
        <i class="icon-tag icon-large"></i>molog
    </a>
</li>
<li class="tag-1">
    <a href="http://smetj.net/tag/graphite.html">
        <i class="icon-tag icon-large"></i>graphite
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/mod_gearman.html">
        <i class="icon-tag icon-large"></i>mod_gearman
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/mqtt.html">
        <i class="icon-tag icon-large"></i>mqtt
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/gevent.html">
        <i class="icon-tag icon-large"></i>gevent
    </a>
</li>
<li class="tag-3">
    <a href="http://smetj.net/tag/monitoring.html">
        <i class="icon-tag icon-large"></i>monitoring
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/pypy.html">
        <i class="icon-tag icon-large"></i>pypy
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/tools.html">
        <i class="icon-tag icon-large"></i>tools
    </a>
</li>
<li class="tag-1">
    <a href="http://smetj.net/tag/metricfactory.html">
        <i class="icon-tag icon-large"></i>metricfactory
    </a>
</li>
<li class="tag-2">
    <a href="http://smetj.net/tag/metrics.html">
        <i class="icon-tag icon-large"></i>metrics
    </a>
</li>
<li class="tag-1">
    <a href="http://smetj.net/tag/python.html">
        <i class="icon-tag icon-large"></i>python
    </a>
</li>
<li class="tag-4">
    <a href="http://smetj.net/tag/events.html">
        <i class="icon-tag icon-large"></i>events
    </a>
</li>
<li class="tag-2">
    <a href="http://smetj.net/tag/wishbone.html">
        <i class="icon-tag icon-large"></i>wishbone
    </a>
</li>


</ul>        </div><!--/.well -->
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Anything to MQTT">
                                        Anything to MQTT
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2013-11-08T23:00:00">
        <i class="icon-calendar"></i>vr 08 november 2013
</abbr>
<span class="label">By</span>
<a href="http://smetj.net/author/smetj.html"><i class="icon-user"></i>smetj</a>
<span class="label">Category</span>
<a href="http://smetj.net/category/engineering.html"><i class="icon-folder-open"></i>engineering</a>.


<span class="label">Tags</span>
	<a href="http://smetj.net/tag/wishbone.html"><i class="icon-tag"></i>wishbone</a>
	<a href="http://smetj.net/tag/mqtt.html"><i class="icon-tag"></i>mqtt</a>
	<a href="http://smetj.net/tag/python.html"><i class="icon-tag"></i>python</a>
</footer><!-- /.post-info -->                </div>
                <p>In this blog post I would like to demonstrate the how easy it is to setup a
Wishbone server which allows you to send data from bash to a MQTT broker.</p>
<p></p>
<p>To install Wishbone you can follow the instructions found in the project
<a class="reference external" href="http://wishbone.readthedocs.org/en/latest/installation.html">documentation</a>.</p>
<div class="section" id="our-setup">
<h2>Our setup</h2>
<p>Have a server up and running with following properties:</p>
<ul class="simple">
<li>Listens on 3 different named pipes.</li>
<li>Each named pipe has a certain routing key associated with it.</li>
<li>Data submitted into the named pipe is routed to a MQTT broker using the
routing key associated with the named pipe.</li>
</ul>
<p>The following bootstrap file starts a server with those properties:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre>  ---
  modules:
      input_red:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_red

      input_green:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_green

      input_blue:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_blue

      header_red:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/red

      header_green:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/green

      header_blue:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/blue

      funnel:
          module: wishbone.builtin.flow.funnel

      mqtt:
          module: wishbone.output.mqtt
          arguments:
              host: rabbitmq

  routingtable:

      - input_red.outbox        -&gt; header_red.inbox
      - header_red.outbox       -&gt; funnel.one

      - input_green.outbox      -&gt; header_green.inbox
      - header_green.outbox     -&gt; funnel.two

      - input_blue.outbox       -&gt; header_blue.inbox
      - header_blue.outbox      -&gt; funnel.three

      - funnel.outbox           -&gt; mqtt.inbox
  ...
</pre></div>
</td></tr></table><div class="section" id="breakdown">
<h3>Breakdown</h3>
<p>Let's break down the different parts of this bootstrap file and start with the
modules section:</p>
<p>The named pipes are created by initializing 3 instances of the
<em>wishbone.input.namedpipe</em> module (line 4, 9, 14).  Each instance is assigned
a name: input_red, input_green and input_blue respectively (line 3, 8, 13).
The only argument defined for these instances is the path of the named pipe
(line 6, 11, 16)</p>
<p>For each event submitted to the named pipe, we have to add the routing key to
the header of the event.  This is required at a later stage when the event
enters the <em>mqtt</em> module. 3 instances of the header module are initiated named
header_red, header_green, header_blue respectively (line 18, 25, 32).
Depending on through which header module instance an event travels the
information is stored under a key called <em>mqtt</em> (line 21, 28, 35).  Each of
these values contain a one element dictionary with the topic name (line 23,
30, 37) using the format the <em>mqtt</em> module expects.</p>
<p>In Wishbone you cannot connect multiple queues to 1 queue.  This is by design.
Queues always have a &quot;one to one&quot; relationship.  Since all data submitted to
the 3 named pipes has to go to 1 MQTT, we could in theory have 3 dedicated
mqtt module instances but that would be a waste.  Therefor we initialize the
<em>funnel</em> module.  The <em>funnel</em> module allows multiple input queues and merges
those input queues into its output queue, which allows us to only having to
define 1 output module.</p>
<p>Finally we have the MQTT output module which is initialized using the name
<em>mqtt</em> (line 42).  The <em>mqtt</em> submits incoming events towards an MQTT server.
The only argument we require to initialize the module is the hostname or
address of the server (line 45).  The mqtt output module expects for each
incoming event some data in the header of the event, so it knows which routing
key to use when submitting the event.</p>
</div>
<div class="section" id="the-routing-table">
<h3>The routing table</h3>
<p>The routing table (line 47) defines which queues are connected towards each
other which basically defines the flow of events throughout the different
modules.  If we would graphically represent the defines routing table it would
look like this:</p>
<p><a class="reference external" href="pics/anything-to-mqtt/diagram.png"><img alt="diagram" src="pics/anything-to-mqtt/diagram.png" /></a></p>
<p>Each <em>named pipe</em> module instance is connected to its dedicated <em>header</em>
module instance.  Each <em>header</em> module instance is connected to the <em>funnel</em>
module instance.  The names of the incoming queues of the funnel can be chosen
freely (line 50, 53, 56).  The moment a connection is made, the queue is
automatically created.</p>
<p>The output of the <em>funnel</em> module instance is then connected to the <em>mqtt</em>
module instance, which submits the incoming events to the outside world (line
58).</p>
</div>
</div>
<div class="section" id="running-the-setup">
<h2>Running the setup</h2>
<p>Save the above bootstrap to a file.  The start the Wishbone setup in the
foreground using the bootstrap file by executing:</p>
<pre class="literal-block">
$ wishbone debug --config anything_to_mqtt.yaml
</pre>
<p>From CLI we can now submit data into the MQTT server by writing to one of the
named pipes:</p>
<pre class="literal-block">
$  echo &quot;ho ho ho, santa is here&quot; &gt; /tmp/wishbone_red
</pre>
</div>
<div class="section" id="final-thoughts">
<h2>Final thoughts</h2>
<p>While this setup as such does not have much practical use, I hope to have
demonstrated flexibility of the Wishbone framework and what kind of solutions
can be built with it.  More input (and other) modules are available on
<a class="reference external" href="https://github.com/smetj/wishboneModules">Github</a> offering more combinations and possibilities which might suit your
specific needs.</p>
</div>

                </div><!-- /.entry-content -->
                <div class="comments">
		</br>
                <h2>Comments</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "anything-to-mqtt.html";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://smetj.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
	var pageTracker = _gat._getTracker("UA-40703057-1");
pageTracker._trackPageview();
} catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'smetj';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://smetj.net/theme/js/jquery-1.7.2.min.js"></script>
    <script src="http://smetj.net/theme/js/bootstrap.min.js"></script>
  </body>
</html>