<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Hammer MQTT</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Hammer MQTT"/>
            <meta property="og:url" content="http://smetj.net/hammer-mqtt-amqp.html"/>
            <meta property="og:description" content="In this article we will look into the message throughput of MQTT and AMQP. We can use Wishbone to generate messages and submit them into a message broker such as RabbitMQ or Mosquitto and write the Wishbone performance metrics into Graphite."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://smetj.net/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://smetj.net/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://smetj.net/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://smetj.net/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>


    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-40703057-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://smetj.net" class="navbar-brand">Project site of Jelle Smet</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://smetj.net/category/development.html">Development</a>
                        </li>
                        <li class="active">
                            <a href="http://smetj.net/category/engineering.html">Engineering</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://smetj.net/category/monitoringlove.html">#monitoringlove</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://smetj.net/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://smetj.net/hammer-mqtt-amqp.html"
                       rel="bookmark"
                       title="Permalink to Hammer MQTT">
                        Hammer MQTT
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>za 09 november 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="http://smetj.net/tag/wishbone.html">wishbone</a>
        /
	<a href="http://smetj.net/tag/mqtt.html">mqtt</a>
        /
	<a href="http://smetj.net/tag/amqp.html">amqp</a>
        /
	<a href="http://smetj.net/tag/rabbitmq.html">rabbitmq</a>
        /
	<a href="http://smetj.net/tag/mosquitto.html">mosquitto</a>
        /
	<a href="http://smetj.net/tag/python.html">python</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In this article we will look into the message throughput of MQTT and AMQP.  We
can use Wishbone to generate messages and submit them into a message broker
such as RabbitMQ or Mosquitto and write the Wishbone performance metrics into
Graphite.</p>
<p></p>
<p>To install Wishbone and modules you can follow the instructions found in the
project <a class="reference external" href="http://wishbone.readthedocs.org/en/latest/installation.html">documentation</a>.</p>
<p>3 more modules are required:</p>
<ul class="simple">
<li>wb_output_tcp (if you want the Graphite metrics)</li>
<li>wb_output_amqp</li>
<li>wb_output_mqtt</li>
</ul>
<div class="section" id="setup">
<h2>Setup</h2>
<ul class="simple">
<li>Server 1
- Virtualbox guest, Centos 6.3
- 2048 MB Ram
- 2 CPU's
- RabbitMQ 3.2.0
- Erlang R114B04</li>
<li>Server 2
- Virtualbox guest, Centos 6.3
- 2048 MB Ram
- 2 CPU's
- Mosquitto</li>
</ul>
</div>
<div class="section" id="testing-throughput">
<h2>Testing throughput</h2>
<p>I have RabbitMQ with the MQ</p>
<p>We will setup a server which generates messages to both</p>
<p>Have a server up and running with following properties:</p>
<ul class="simple">
<li>Listens on 3 different named pipes.</li>
<li>Each named pipe has a certain routing key associated with it.</li>
<li>Data submitted into the named pipe is routed to a MQTT broker using the
routing key associated with the named pipe.</li>
</ul>
<p>The following bootstrap file starts a server with those properties:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre>  ---
  modules:
      input_red:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_red

      input_green:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_green

      input_blue:
          module: wishbone.input.namedpipe
          arguments:
              path: /tmp/wishbone_blue

      header_red:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/red

      header_green:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/green

      header_blue:
          module: wishbone.builtin.function.header
          arguments:
              key: mqtt
              header:
                  topic: color/blue

      funnel:
          module: wishbone.builtin.flow.funnel

      mqtt:
          module: wishbone.output.mqtt
          arguments:
              host: rabbitmq

  routingtable:

      - input_red.outbox        -&gt; header_red.inbox
      - header_red.outbox       -&gt; funnel.one

      - input_green.outbox      -&gt; header_green.inbox
      - header_green.outbox     -&gt; funnel.two

      - input_blue.outbox       -&gt; header_blue.inbox
      - header_blue.outbox      -&gt; funnel.three

      - funnel.outbox           -&gt; mqtt.inbox
  ...
</pre></div>
</td></tr></table><div class="section" id="breakdown">
<h3>Breakdown</h3>
<p>Let's break down the different parts of this bootstrap file and start with the
modules section:</p>
<p>The named pipes are created by initializing 3 instances of the
<em>wishbone.input.namedpipe</em> module (line 4, 9, 14).  Each instance is assigned
a name: input_red, input_green and input_blue respectively (line 3, 8, 13).
The only argument defined for these instances is the path of the named pipe
(line 6, 11, 16)</p>
<p>For each event submitted to the named pipe, we have to add the routing key to
the header of the event.  This is required at a later stage when the event
enters the <em>mqtt</em> module. 3 instances of the header module are initiated named
header_red, header_green, header_blue respectively (line 18, 25, 32).
Depending on through which header module instance an event travels the
information is stored under a key called <em>mqtt</em> (line 21, 28, 35).  Each of
these values contain a one element dictionary with the topic name (line 23,
30, 37) using the format the <em>mqtt</em> module expects.</p>
<p>In Wishbone you cannot connect multiple queues to 1 queue.  This is by design.
Queues always have a &quot;one to one&quot; relationship.  Since all data submitted to
the 3 named pipes has to go to 1 MQTT, we could in theory have 3 dedicated
mqtt module instances but that would be a waste.  Therefor we initialize the
<em>funnel</em> module.  The <em>funnel</em> module allows multiple input queues and merges
those input queues into its output queue, which allows us to only having to
define 1 output module.</p>
<p>Finally we have the MQTT output module which is initialized using the name
<em>mqtt</em> (line 42).  The <em>mqtt</em> submits incoming events towards an MQTT server.
The only argument we require to initialize the module is the hostname or
address of the server (line 45).  The mqtt output module expects for each
incoming event some data in the header of the event, so it knows which routing
key to use when submitting the event.</p>
</div>
<div class="section" id="the-routing-table">
<h3>The routing table</h3>
<p>The routing table (line 47) defines which queues are connected towards each
other which basically defines the flow of events throughout the different
modules.  If we would graphically represent the defines routing table it would
look like this:</p>
<p><a class="reference external" href="pics/anything-to-mqtt/diagram.png"><img alt="diagram" src="pics/anything-to-mqtt/diagram.png" /></a></p>
<p>Each <em>named pipe</em> module instance is connected to its dedicated <em>header</em>
module instance.  Each <em>header</em> module instance is connected to the <em>funnel</em>
module instance.  The names of the incoming queues of the funnel can be chosen
freely (line 50, 53, 56).  The moment a connection is made, the queue is
automatically created.</p>
<p>The output of the <em>funnel</em> module instance is then connected to the <em>mqtt</em>
module instance, which submits the incoming events to the outside world (line
58).</p>
</div>
</div>
<div class="section" id="running-the-setup">
<h2>Running the setup</h2>
<p>Save the above bootstrap to a file.  The start the Wishbone setup in the
foreground using the bootstrap file by executing:</p>
<pre class="literal-block">
$ wishbone debug --config anything_to_mqtt.yaml
</pre>
<p>From CLI we can now submit data into the MQTT server by writing to one of the
named pipes:</p>
<pre class="literal-block">
$  echo &quot;ho ho ho, santa is here&quot; &gt; /tmp/wishbone_red
</pre>
</div>
<div class="section" id="final-thoughts">
<h2>Final thoughts</h2>
<p>While this setup as such does not have much practical use, I hope to have
demonstrated flexibility of the Wishbone framework and what kind of solutions
can be built with it.  More input (and other) modules are available on
<a class="reference external" href="https://github.com/smetj/wishboneModules">Github</a> offering more combinations and possibilities which might suit your
specific needs.</p>
</div>

            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'smetj'; // required: replace example with your forum shortname
            var disqus_identifier = 'hammer-mqtt-amqp';
            var disqus_url = 'http://smetj.net/hammer-mqtt-amqp.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/smetj"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/smetj"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



                <li class="list-group-item"><a href="http://smetj.net/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/moncli.html">
                                moncli
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/graphite.html">
                                graphite
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/metricfactory.html">
                                metricfactory
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://smetj.net/tag/monitoringlove.html">
                                monitoringlove
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/wishbone.html">
                                wishbone
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/metrics.html">
                                metrics
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://smetj.net/tag/rabbitmq.html">
                                rabbitmq
                            </a>
                        </li>
                        <li class="list-group-item tag-3">
                            <a href="http://smetj.net/tag/monitoring.html">
                                monitoring
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/krolyk.html">
                                krolyk
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/elasticsearch.html">
                                elasticsearch
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/nagios.html">
                                nagios
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/pypy.html">
                                pypy
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/company.html">
                                company
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/messaging.html">
                                messaging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/tools.html">
                                tools
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/gevent.html">
                                gevent
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/amqp.html">
                                amqp
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/events.html">
                                events
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/molog.html">
                                molog
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mod_gearman.html">
                                mod_gearman
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://smetj.net/tag/mqtt.html">
                                mqtt
                            </a>
                        </li>
        </ul>
    </section>


    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://smetj.net/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'smetj',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://smetj.net/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2013 Jelle Smet &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://smetj.net/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://smetj.net/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'smetj'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>